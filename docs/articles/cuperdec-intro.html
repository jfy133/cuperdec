<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to cuperdec • cuperdec</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to cuperdec">
<meta property="og:description" content="cuperdec">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cuperdec</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cuperdec-intro.html">Introduction to cuperdec</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jfy133/cuperdec/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="cuperdec-intro_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to cuperdec</h1>
                        <h4 class="author">James A. Fellows Yates</h4>
            
            <h4 class="date">2021-09-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jfy133/cuperdec/blob/master/vignettes/cuperdec-intro.Rmd"><code>vignettes/cuperdec-intro.Rmd</code></a></small>
      <div class="hidden name"><code>cuperdec-intro.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette gives an example on how to use the <code>cuperdec</code> R package. The aim of this package is to assist in the generation of what I have termed ’cumulative percent decay curves`.</p>
<p>These visualisations were originally developed to assist in the identification of the abundance and prevalence of microbial taxa in ancient microbiome samples, with samples with high abundance and prevalence of the expected original microbiome, when comparing to modern samples from the same microbiome source. However, this concept could potentially be applied in other contexts.</p>
<p>The curves consist of an ‘abundance rank’ (x-axis), and a percentage of taxa from the target (i.e.original microbiome) source (y-axis). The curve is generated by asking at each rank, what percentage of the taxa up until this rank have been from the target source. This vignette will show examples later on.</p>
<p>The package also applies a few simple filtering functions, which helps to automate the detection of samples that are similar to modern comparative samples, versus those that do not have the same signal. This can then be used to inform downstream analyses in terms of discarding potentially unreliable samples.</p>
</div>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>You will require the library <a href="https://dplyr.tidyverse.org/"><code>dplyr</code></a> for this tutorial! Please install this if you have not already.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org">"dplyr"</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="input" class="section level1">
<h1 class="hasAnchor">
<a href="#input" class="anchor"></a>Input</h1>
<div id="required" class="section level2">
<h2 class="hasAnchor">
<a href="#required" class="anchor"></a>Required</h2>
<p>The generation of these curves require at a minimum:</p>
<ul>
<li>A TSV formatted ‘OTU Table’ with the following characteristics:
<ul>
<li>Column names: e.g. Taxon, Sample_A, Sample_B, Sample_C</li>
<li>First Column: a list of taxa</li>
<li>Cells: some numeric value representing number of observations of a taxon in a sample</li>
</ul>
</li>
</ul>
<table class="table">
<thead><tr class="header">
<th align="center">Taxon</th>
<th align="right">Sample_A</th>
<th align="right">Sample_B</th>
<th align="right">Sample_C</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Taxon_1</td>
<td align="right">0</td>
<td align="right">102</td>
<td align="right">237</td>
</tr>
<tr class="even">
<td align="center">Taxon_2</td>
<td align="right">10023</td>
<td align="right">7483</td>
<td align="right">298</td>
</tr>
<tr class="odd">
<td align="center">Taxon_3</td>
<td align="right">6</td>
<td align="right">28</td>
<td align="right">3409</td>
</tr>
<tr class="even">
<td align="center">…</td>
<td align="right">…</td>
<td align="right">…</td>
<td align="right">…</td>
</tr>
</tbody>
</table>
<ul>
<li>A TSV formatted isolation source table with two columns:
<ul>
<li>A list of taxa that matches the names in your OTU table (e.g. <em>Tannerella forsythia</em>, <em>Helicobacter pylori</em>, <em>Mycobacterium kansasii</em>)</li>
<li>The corresponding isolation sources of each taxon, i.e. where the particular reference sequence of the taxon was extracted (e.g. oral cavity, gut, soil)</li>
</ul>
</li>
</ul>
<table class="table">
<thead><tr class="header">
<th align="center">Taxon</th>
<th align="center">Sample_A</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Taxon_1</td>
<td align="center">oral</td>
</tr>
<tr class="even">
<td align="center">Taxon_2</td>
<td align="center">gut</td>
</tr>
<tr class="odd">
<td align="center">Taxon_3</td>
<td align="center">unknown</td>
</tr>
<tr class="even">
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody>
</table>
</div>
<div id="optional" class="section level2">
<h2 class="hasAnchor">
<a href="#optional" class="anchor"></a>Optional</h2>
<p>Additionally, you can supply:</p>
<ul>
<li>A TSV formatted metadata table, which contains:
<ul>
<li>A column with sample names (matching OTU table)</li>
<li>A grouping column (i.e. allows grouping of samples to be displayed together)</li>
</ul>
</li>
</ul>
<table class="table">
<thead><tr class="header">
<th align="center">Samples</th>
<th align="center">Other</th>
<th align="center">Group</th>
<th align="right">Other</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Sample_A</td>
<td align="center">False</td>
<td align="center">Group_A</td>
<td align="right">23,000</td>
</tr>
<tr class="even">
<td align="center">Sample_B</td>
<td align="center">True</td>
<td align="center">Group_A</td>
<td align="right">4,000</td>
</tr>
<tr class="odd">
<td align="center">Sample_C</td>
<td align="center">True</td>
<td align="center">Group_B</td>
<td align="right">15,000</td>
</tr>
<tr class="even">
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="right">…</td>
</tr>
</tbody>
</table>
<p>In this example, we will use a dataset from Fellows Yates <em>et al.</em> 202X. This study looked at microbiome DNA isolated from dental calculus of ancient skeletons. We wanted to try to identify samples which appeared to have still displayed evidence of the remains original microbes that makes up a tooth biofilm. This allowed us to discard any samples that were so degraded no signature of the original microbiome remained, and that could negatively influence downstream analyses.</p>
<p>This assessment can be done by by comparing the curves of the ancient samples with modern samples of known isolation sources.</p>
</div>
</div>
<div id="data-loading" class="section level1">
<h1 class="hasAnchor">
<a href="#data-loading" class="anchor"></a>Data Loading</h1>
<p>First we will load the <code>cuperdec</code> package, and helper libraries to help make reading R code easier in this vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jfy133/cuperdec">cuperdec</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span> <span class="co">## for pipes!</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span> <span class="co"># for mutate()!</span></code></pre></div>
<p>Next we can load the example dataset that comes with the package with the helper functions that load and format the tables that can be used by downstream <code>cuperdec</code> functions.</p>
<p>The example data is stored within the package, so we first need find the locations of these in your system.</p>
<blockquote>
<p>:warning: You would not normally have to run this step for your own analysis!</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">cuperdec_taxatable_ex</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">cuperdec_database_ex</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">cuperdec_metadata_ex</span><span class="op">)</span></code></pre></div>
<p>Now we can use the loading functions to load the tables for you.</p>
<p>You can either supply your table as a path to a TSV on your computer, or alternatively a data frame/tibble that you’ve already loaded into R.</p>
<p>The function <code><a href="../reference/load_taxa_table.html">load_taxa_table()</a></code> will then convert a OTU table into long format and rename columns to names that downstream functions will use.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">taxatable</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_taxa_table.html">load_taxa_table</a></span><span class="op">(</span><span class="va">cuperdec_taxatable_ex</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 66,187 × 3
##    Taxon                     Sample             Count
##    &lt;chr&gt;                     &lt;chr&gt;              &lt;dbl&gt;
##  1 Acidobacterium capsulatum ARS020.A0101.SG1.2   482
##  2 Acidobacterium capsulatum ARS012.A0101.SG1.2   278
##  3 Acidobacterium capsulatum ERR1883438           232
##  4 Acidobacterium capsulatum ERR1883424           407
##  5 Acidobacterium capsulatum ARS013.A0101.SG1.2   566
##  6 Acidobacterium capsulatum ARS004.A0101.SG1.2   384
##  7 Acidobacterium capsulatum ARS017.A0101.SG1.2  1005
##  8 Acidobacterium capsulatum ARS005.A0101.SG1.2   429
##  9 Acidobacterium capsulatum ERR1883421           181
## 10 Acidobacterium capsulatum ARS011.A0101.SG1.2   291
## # … with 66,177 more rows</code></pre>
<p>Alternatively you can provide a path directly to a TSV table (not run here), rather than an already loaded object.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">taxatable</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_taxa_table.html">load_taxa_table</a></span><span class="op">(</span><span class="st">"/&lt;path&gt;/&lt;to&gt;/&lt;file&gt;.tsv"</span><span class="op">)</span></code></pre></div>
<p>Next we need to use<code><a href="../reference/load_database.html">load_database()</a></code> to load the file which describes the original isolation source of each OTU. Again, this function can take either a path to a file on your system, or a data frame already loaded into R.</p>
<p>This function takes two parameters, in addition to the the isolation source table itself, and you also need to supply the name of the target isolation source you are looking for within each sample.</p>
<p>In this case, we want to identify the all the taxa in our samples that have been isolated in from the oral cavity - indicated in the database file’s second column as ‘oral’. The <code><a href="../reference/load_database.html">load_database()</a></code> function will then indicate for every Taxon that is derived from the target source as ‘True’ and everything that isn’t as ‘False’.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">database</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_database.html">load_database</a></span><span class="op">(</span><span class="va">cuperdec_database_ex</span>, target <span class="op">=</span> <span class="st">"oral"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 569 × 2
##    Taxon                            Isolation_Source
##    &lt;chr&gt;                            &lt;lgl&gt;           
##  1 Abiotrophia defectiva            TRUE            
##  2 Achromobacter xylosoxidans       TRUE            
##  3 Acinetobacter baumannii          FALSE           
##  4 Actinobaculum sp. oral taxon 183 TRUE            
##  5 Actinomyces cardiffensis         TRUE            
##  6 Actinomyces dentalis             TRUE            
##  7 Actinomyces georgiae             TRUE            
##  8 Actinomyces gerencseriae         TRUE            
##  9 Actinomyces graevenitzii         TRUE            
## 10 Actinomyces israelii             TRUE            
## # … with 559 more rows</code></pre>
<p>Finally, in the example study, we wanted to compare the curves of different groups of our samples, with each different known-isolation comparative sample. Therefore, we will load an optional file carrying various metadata about each sample</p>
<p>For this we use <code><a href="../reference/cuperdec_metadata_ex.html">cuperdec_metadata_ex()</a></code>, supplying the metadata TSV, the name of the column with sample names, and the name of the column with the groups. You can have other columns in the metadata file, but only the two indicated will be taken downstream.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">metadata_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span><span class="va">cuperdec_metadata_ex</span>,
                     sample_col <span class="op">=</span> <span class="st">"#SampleID"</span>,
                     source_col <span class="op">=</span> <span class="st">"Env"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 229 × 2
##    Sample             Sample_Source       
##    &lt;chr&gt;              &lt;chr&gt;               
##  1 ABM006.A0101       Gorilla_2           
##  2 ABM007.A0101       Chimp_3             
##  3 ABM008.A0101       Chimp_3             
##  4 ARS001.A0101.SG1.2 EnvironmentalControl
##  5 ARS004.A0101.SG1.2 EnvironmentalControl
##  6 ARS005.A0101.SG1.2 EnvironmentalControl
##  7 ARS010.A0101.SG1.2 EnvironmentalControl
##  8 ARS011.A0101.SG1.2 EnvironmentalControl
##  9 ARS012.A0101.SG1.2 EnvironmentalControl
## 10 ARS013.A0101.SG1.2 EnvironmentalControl
## # … with 219 more rows</code></pre>
</div>
<div id="calculating-a-simple-curve" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-a-simple-curve" class="anchor"></a>Calculating a simple curve</h1>
<p>Now, with all our data loaded we can calculate the cumulative percent curves per sample.</p>
<p>The way this works is to order (per sample) each taxon by it’s abundance. Then, calculate the fraction of taxa at each rank, that have come from your ‘target’ source ( including all ranks up until the current one).</p>
<p>A schematic can be seen on Figure R8 in <a href="https://github.com/jfy133/Hominid_Calculus_Microbiome_Evolution/tree/master/#r81-cumulative-percent-decay-plots">GitHub repository</a> of Fellows Yates <em>et al.</em> (202X).</p>
<p>To do these of the taxa table loaded above, we use the <code><a href="../reference/calculate_curve.html">calculate_curve()</a></code> function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">curves</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_curve.html">calculate_curve</a></span><span class="op">(</span><span class="va">taxatable</span>, database <span class="op">=</span> <span class="va">database</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 66,187 × 4
## # Groups:   Sample [229]
##    Sample       Taxon                                Rank Fraction_Target
##    &lt;chr&gt;        &lt;chr&gt;                               &lt;int&gt;           &lt;dbl&gt;
##  1 ABM006.A0101 Actinomyces meyeri                      1             100
##  2 ABM006.A0101 Actinomyces sp. oral taxon 414          2             100
##  3 ABM006.A0101 Campylobacter gracilis                  3             100
##  4 ABM006.A0101 Pseudopropionibacterium propionicum     4             100
##  5 ABM006.A0101 Fusobacterium nucleatum                 5             100
##  6 ABM006.A0101 Olsenella sp. oral taxon 807            6             100
##  7 ABM006.A0101 Eikenella corrodens                     7             100
##  8 ABM006.A0101 Streptococcus troglodytae               8             100
##  9 ABM006.A0101 Ottowia sp. oral taxon 894              9             100
## 10 ABM006.A0101 Fretibacterium fastidiosum             10             100
## # … with 66,177 more rows</code></pre>
<p>Here you can see a Rank column, which represents the abundance rank of each taxon (from smallest to largest rank representing most to least abundant), and a fraction of all taxa up to that rank that are derived from your target isolation source.</p>
<p><code>cuperdec</code> also offers a helper function for fast plotting.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<blockquote>
<p>Note that these functions just run basic <code>ggplot()</code> functions with a couple of preferred theming based on the preferences of the package’s author. You can adapt the functions for your own function by running the internal <code>plot_simple</code> function without brackets to see the ggplot2 function, and copying the ggplot2 function from there.</p>
</blockquote>
<p>Due to the large number of samples in the example data, we cannot see much. To improve this, we can use a second plotting function to separate each group of samples into their own window.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span>, <span class="va">metadata_map</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>This is much easier to visualise, and we can start to see some differences.</p>
<p>Note that if you wanted to re-order the order panels, you can simply convert the ‘Sample_Source’ column of the <code>metadata_map</code> to factors, with your preferred ordering. For example:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Set ordering of groups</span>
<span class="va">group_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"subPlaque"</span>,
               <span class="st">"supPlaque"</span>,
               <span class="st">"urbanGut"</span>,
               <span class="st">"ruralGut"</span>,
               <span class="st">"skin"</span>,
               <span class="st">"sediment"</span>,
               <span class="st">"EnvironmentalControl"</span>,
               <span class="st">"ExtractionControl"</span>,
               <span class="st">"LibraryControl"</span>,
               <span class="st">"Howler_Monkey"</span>,
               <span class="st">"Gorilla_1"</span>,
               <span class="st">"Gorilla_2"</span>,
               <span class="st">"Gorilla_3"</span>,
               <span class="st">"Chimp_1"</span>,
               <span class="st">"Chimp_2"</span>,
               <span class="st">"Chimp_3"</span>,
               <span class="st">"Chimp_4"</span>,
               <span class="st">"Neanderthal"</span>,
               <span class="st">"PreagriculturalHuman_1"</span>,
               <span class="st">"PreagriculturalHuman_2"</span>,
               <span class="st">"PreantibioticHuman_1"</span>,
               <span class="st">"PreantibioticHuman_2"</span>,
               <span class="st">"ModernDayHuman_1"</span>,
               <span class="st">"ModernDayHuman_2"</span>
<span class="op">)</span>

<span class="va">metadata_map</span> <span class="op">&lt;-</span> <span class="va">metadata_map</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Sample_Source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Sample_Source</span>, levels <span class="op">=</span> <span class="va">group_order</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Re-plot</span>
<span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span>, metadata <span class="op">=</span> <span class="va">metadata_map</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Now we can see that the calculus samples (Howler monkey onwards), look much more like the Plaque samples, compared to e.g. sediment and skin.</p>
</div>
<div id="preservation-filtering" class="section level1">
<h1 class="hasAnchor">
<a href="#preservation-filtering" class="anchor"></a>Preservation filtering</h1>
<div id="simple" class="section level2">
<h2 class="hasAnchor">
<a href="#simple" class="anchor"></a>Simple</h2>
<p>These visualisation of these difference curves already start help us to distinguish well-preserved samples from those that maybe have few oral taxa left remaining. However, we can also try and use the observations from the plot above to set up cut-off filters that allows us to make consistent ‘keep’/‘discard’ decisions.</p>
<p>For example, other than a single extraction control, all non-plaque comparative samples do not exceed a minimum ‘Percentage Target Source’ threshold of ~50%.</p>
<p>Using observations like this <code>cuperdec</code> offers a range of different functions that perform various cut-off assessments between samples. For example, we can use <code><a href="../reference/simple_filter.html">simple_filter()</a></code> to indicate any sample that exceeds a minimum percent source threshold of 50% at any point along the abundance rank.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simple_filter.html">simple_filter</a></span><span class="op">(</span><span class="va">curves</span>, percent_threshold <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 229 × 2
##    Sample             Passed
##    &lt;chr&gt;              &lt;lgl&gt; 
##  1 ABM006.A0101       TRUE  
##  2 ABM007.A0101       TRUE  
##  3 ABM008.A0101       TRUE  
##  4 ARS001.A0101.SG1.2 FALSE 
##  5 ARS004.A0101.SG1.2 FALSE 
##  6 ARS005.A0101.SG1.2 FALSE 
##  7 ARS010.A0101.SG1.2 FALSE 
##  8 ARS011.A0101.SG1.2 FALSE 
##  9 ARS012.A0101.SG1.2 FALSE 
## 10 ARS013.A0101.SG1.2 FALSE 
## # … with 219 more rows</code></pre>
<p>We can then supply this information as an additional parameter for plotting.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span>, <span class="va">metadata_map</span>, <span class="va">filter_result</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>As a demonstration, the defined cut-off means that any curve that enters the yellow box at any abundance rank (i.e. above the minimum 50% threshold at any point across the x-axis) is considered as being <code>Passed</code>.</p>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
<div id="hard-burnin" class="section level2">
<h2 class="hasAnchor">
<a href="#hard-burnin" class="anchor"></a>Hard Burnin</h2>
<p>The list of samples generated by <code><a href="../reference/simple_filter.html">simple_filter()</a></code> above could now be used to discard those samples that did not pass the cut off from downstream analysis.</p>
<p>However, the one ExtractionControl sample that exceeds 50% for only a couple of ranks, actually looks like for the most part that it doesn’t look like it has much ‘oral’ taxa at all. It may just be spurious hits, or an over-weighting due to the small denominator of the abundance rank in the early ranks.</p>
<p>Therefore, we can additionally apply a simple ‘burn in’, after which we start considering whether the curve exceeds the minimum percent threshold. In other words, only consider whether a given curve goes above 50% after X amount of ranks (given here as 1.0% of the ranks), for each curve. Alternatively phrase, ignore the first 10% ranks of each sample before checking if the curve goes above 50% of the target source.</p>
<p>To do this on the full dataset</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">burnin_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hard_burnin_filter.html">hard_burnin_filter</a></span><span class="op">(</span><span class="va">curves</span>,
                                    percent_threshold <span class="op">=</span> <span class="fl">50</span>,
                                    rank_burnin <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span>, <span class="va">metadata_map</span>, <span class="va">burnin_result</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p>This is better, but now we have a Neanderthal and a few pre-agricultural humans that clearly exceed 50% for quite a few ranks, so while preservation might still be lower than others, they may still have <em>sufficient</em> preservation that we still want to keep these samples for downstream.</p>
<p>We can also supply an extra parameter to <code>plot_cuperdec</code> Lets look a bit more closely at the curves to by restricting the X-axis Ranks to 250 ranks.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span>, <span class="va">metadata_map</span>, <span class="va">burnin_result</span>, restrict_x <span class="op">=</span> <span class="fl">250</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>We can again graphically demonstrate the burn-in thresholds of a <em>single sample</em> for this filter, following the yellow-box example in the previous section, see the following image.</p>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<blockquote>
<p>Note this image is purely for demonstrative purposes, and is not from a <code>cuperdec</code> function.</p>
</blockquote>
<p>You can see the boxes specifying where the curves of each sample must enter has now shifted away from 0 along the x-axis.</p>
<p>One sample’s curve enters its box (yellow, i.e. after the 10% burning threshold of24 the abundance rank) and therefore is considered passing the minimum percent target source threshold. In contrast, the ‘failed’ sample has a curve falls just outside of its box (pink), has a 10% burn-in threshold of rank 31.</p>
<p>The different boxes emphasise that the burn-in is calculated on a <em>per-sample</em> basis, and that there is not a single abundance rank cut-off for all samples.</p>
<p>However, when looking back at the whole dataset definitely see that there are some Neanderthals that are excluded with a hard burn-in of 10% despite having otherwise a curve pretty similar to other Neanderthals. This could be because they have unusually long tails of very low abundant taxa, meaning that the ‘peak’ exceeding the minimum threshold of 50% occurs within the first 10% of ranks, however this is still the region of theabundance rank that would give the strongest oral taxon signal in very old samples.</p>
</div>
<div id="adaptive-burnin" class="section level2">
<h2 class="hasAnchor">
<a href="#adaptive-burnin" class="anchor"></a>Adaptive Burnin</h2>
<p>Instead, we can try and customise the burn-in setting on a per-sample basis, based on the amount of ‘fluctuation’ that occurs early in the curves (based on the small fraction denominators).</p>
<p>This is performed here by only starting to considering whether a curve exceeds minimum percentage target source threshold (50%), from the point at which the difference of the percentage target source of one rank to the next, does not exceed the standard-deviation of all differences.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">burnin_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adaptive_burnin_filter.html">adaptive_burnin_filter</a></span><span class="op">(</span><span class="va">curves</span>, percent_threshold <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_cuperdec.html">plot_cuperdec</a></span><span class="op">(</span><span class="va">curves</span>, <span class="va">metadata_map</span>, <span class="va">burnin_result</span>, restrict_x <span class="op">=</span> <span class="fl">250</span><span class="op">)</span></code></pre></div>
<p><img src="cuperdec-intro_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>As with the hard burn-in filter, each curve (i.e., sample) gets a different<br>
abundance rank, after which exceeding of the minimum percent target source is considered.</p>
<p>Once we are happy that the curves appear to be distinguishing between well-preserved samples and those with a low ‘endogenous’ microbial content, we can use the list of samples that did not our thresholds to remove from downstream analysis.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">discard_list</span> <span class="op">&lt;-</span> <span class="va">burnin_result</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">Passed</span><span class="op">)</span>
<span class="va">discard_list</span></code></pre></div>
<pre><code>## # A tibble: 120 × 2
##    Sample             Passed
##    &lt;chr&gt;              &lt;lgl&gt; 
##  1 ARS001.A0101.SG1.2 FALSE 
##  2 ARS004.A0101.SG1.2 FALSE 
##  3 ARS005.A0101.SG1.2 FALSE 
##  4 ARS010.A0101.SG1.2 FALSE 
##  5 ARS011.A0101.SG1.2 FALSE 
##  6 ARS012.A0101.SG1.2 FALSE 
##  7 ARS013.A0101.SG1.2 FALSE 
##  8 ARS015.A0101.SG1.2 FALSE 
##  9 ARS017.A0101.SG1.2 FALSE 
## 10 ARS020.A0101.SG1.2 FALSE 
## # … with 110 more rows</code></pre>
</div>
<div id="custom-filters" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-filters" class="anchor"></a>Custom filters</h2>
<p>You can of course write your own functions with your own filtering techniques, the only requirement is that you produce a two column output:</p>
<ul>
<li>Sample: the names of each sample represented in the curves file.</li>
<li>Passed: a logical (TRUE/FALSE) column indicating whether a sample passed the filter or not</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by James A. Fellows Yates.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
